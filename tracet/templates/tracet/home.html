{% extends "base.html" %}

{% load iso8601 %}
{% load rules %}
{% load votetotext %}

{% block content %}

{% has_perm "tracet.admin_triggers" user as can_admin_triggers %}

<section>

    <aside>
        <h2>Summary</h2>

        {% with obs=recentsuccessfulobservation event=recentsuccessfulobservation.decision.event %}
            <p>
                There are <strong>{{ activetriggercount | default:"no" }} active triggers</strong> (and {{ inactivetriggercount }} inactive).
                {% if obs is not None %}
                    The most recent successful observation was <strong><a href="{{ obs.get_absolute_url }}">{{ obs.created | timesince }} ago</a></strong>
                    triggered by <strong><a href="{{ event.get_absolute_url }}">event {{ event.eventid }}</a></strong> and
                    using the <strong>{{ obs.observatory }}</strong>.
                {% else %}
                    There have not yet been any successful observations.
                {% endif %}
                {% if kafkaok %}
                    The server continues to listen for incoming notices, with the most recent being
                    <strong><a href="{{ mostrecentnotice.get_absolute_url }}">{{ mostrecentnotice.created | timesince }} ago</a></strong>.
                {% else %}
                    The server has <strong>stopped</strong> listening to incoming notices.
                {% endif %}
            </p>
        {% endwith %}
    </aside>

    <aside>
        <h2>Recent activity</h2>

        <table class="left-align">
            <thead>
                <tr>
                    <td>Time</td>
                    <td>Trigger</td>
                    <td>Event ID</td>
                    <td>Event time</td>
                    <td>Conclusion</td>
                    <td>Observation</td>
                </tr>
            </thead>
            <tbody>
                {% for decision in decisions %}
                    {% with event=decision.event trigger=decision.event.trigger %}
                        <tr>
                            <td>
                                <time datetime="{{ decision.created | iso8601 }}" title="{{ decision.created | iso8601 }}">
                                    {{ decision.created | timesince }} ago
                                </time>
                            </td>
                            <td><a href="{{ trigger.get_absolute_url }}">{{ trigger.name }}</a></td>
                            <td><a href="{{ event.get_absolute_url }}">{{ event.eventid }}</a></td>
                            <td>{{ event.time | iso8601 }}</td>
                            <td><span class="vote {% votetotext decision.conclusion %}"></span></td>
                            <td>
                                {% for observation in decision.observations.all %}
                                    <a class="observation-status {{ observation.status }}" title="{{ observation.get_status_display }}" href="{{ observation.get_absolute_url }}">
                                        {{ observation.observatory }}{% if observation.configuration %} ({{ observation.configuration }}){% endif %}
                                    </a>
                                {% empty %}
                                    &mdash;
                                {% endfor %}
                            </td>
                        </tr>
                    {% endwith %}
                {% empty %}
                        <tr><td colspan=6 style="text-align: center;">There has been no activity yet. <a href="{% url 'triggercreate' %}">Create a Trigger</a> and set it to active.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <p>
            <a href="{% url 'triggers' %}">
                View {{ can_admin_triggers | yesno:"& administer,all" }} triggers
            </a>
        </p>
    </aside>

    <aside>
        <h2>Recent observation attempts</h2>

        <table class="left-align">
            <thead>
                <tr><td>Date</td><td>Trigger</td><td>Event ID</td><td>Status</td><td></td></tr>
            </thead>
            <tbody>
                {% for observation in observations %}
                    {% with event=observation.decision.event trigger=observation.decision.event.trigger %}
                        <tr>
                            <td>
                                <time datetime="{{ observation.created | iso8601 }}" title="{{ observation.created | iso8601 }}">
                                    {{ observation.created | timesince }} ago
                                </time>
                            </td>
                            <td><a href="{{ trigger.get_absolute_url }}">{{ trigger.name }}</a></td>
                            <td><a href="{{ event.get_absolute_url }}">{{ event.eventid }}</a></td>
                            <td>
                                <a class="observation-status {{ observation.status }}" title="{{ observation.get_status_display }}" href="{{ observation.get_absolute_url }}">
                                    {{ observation.observatory }}{% if observation.configuration %} ({{ observation.configuration }}){% endif %}
                                </a>
                            </td>
                            <td><a href="{{ observation.get_absolute_url }}">View log</a></td>
                        </tr>
                    {% endwith %}
                {% empty %}
                    <tr><td colspan=6 style="text-align: center;">No (non test) observations have been attempted yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <p><a href="{% url 'observations' %}">View all observations</a></p>
    </aside>

    <aside>
        <h2>Recent notices</h2>

        <table class="left-align">
            <thead>
                <tr><td>Created</td><td>Topic</td><td>View</td></tr>
            </thead>
            <tbody>
                {% for notice in notices %}
                    <tr>
                        <td>
                            <time datetime="{{ notice.created | iso8601 }}" title="{{ notice.created | iso8601 }}">
                                    {{ notice.created | timesince }} ago
                            </time>
                        </td>
                        <td><code>{{ notice.stream.topic }}</code></td>
                        <td><a href="{{ notice.get_absolute_url }}">View</a></td>
                    </tr>
                {% empty %}
                    <tr><td colspan=5 style="text-align: center">There are no notices yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>

        <p><a href="{% url 'notices' %}">View all notices</a></p>
    </aside>

</section>

{% endblock %}